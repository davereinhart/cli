# Nextstrain CLI Development

Development of `nextstrain-cli` happens at <https://github.com/nextstrain/cli>.

We currently target compatibility with Python 3.6 and higher.

Versions for this project follow the [Semantic Versioning rules][].

## Setup

Setup an isolated development environment in `.venv/` with:

    ./devel/setup-venv

Activate the venv to run any of the commands below:

    source .venv/bin/activate

(Or alternatively, run the commands below via `./devel/venv-run â€¦`.)

Now test that you can run:

    nextstrain --help

The development environment includes our dev tools (described below):

    pytest           # runs doctests as well as mypy and flake8
    mypy -p nextstrain.cli
    flake8
    make -C doc livehtml

## Running with local changes

The project is installed into editable mode when using the venv setup above, so
any changes you make during development will be used automatically.

If you need to run with local changes in setups without editable mode, you can
run `./bin/nextstrain` to test your local changes without installing them.
(Note that `./bin/nextstrain` is not the script that gets installed by pip as
`nextstrain`; that script is generated by the `entry_points` configuration in
`setup.py`.)

## External resources

Environment variables can be used to change the location or identity of
external resources/services used by some Nextstrain CLI commands.  This is
helpful when performing manual integration testing against development or
testing resources.

When running the [nextstrain.org server][] locally, you can make the
`nextstrain remote` family of commands talk to it instead of the real
nextstrain.org by setting `NEXTSTRAIN_DOT_ORG`, e.g.:

    NEXTSTRAIN_DOT_ORG=http://localhost:5000 \
      nextstrain remote ls nextstrain.org/groups/test

If you need authenticated access and the local server is using the AWS Cognito
resources from our ["testing" configuration][], you can configure `nextstrain`
with the same, e.g.:

    export NEXTSTRAIN_DOT_ORG=http://localhost:5000
    export NEXTSTRAIN_COGNITO_USER_POOL_ID="$(jq -r .COGNITO_USER_POOL_ID ../nextstrain.org/env/testing/config.json)"
    export NEXTSTRAIN_COGNITO_CLI_CLIENT_ID="$(jq -r .COGNITO_CLI_CLIENT_ID ../nextstrain.org/env/testing/config.json)"
    
    nextstrain login
    nextstrain whoami
    nextstrain remote ls groups/test-private

## Releasing

New releases are made frequently and tagged in git using a [_signed_ tag][].
There is a `./devel/release` script which will prepare a new release from your
local repository.  It ends with instructions for you on how to push the release
commit/tag.

When a release tag is pushed, the [CI workflow][] builds [source
distributions][] and [built distributions][] (wheels), tests them, and if tests
pass, uploads them to [the nextstrain-cli project on
PyPi](https://pypi.org/project/nextstrain-cli).

## Tests

Tests are run with [pytest](https://pytest.org).  To run everything, use:

    ./devel/pytest

This includes the type annotation and static analysis checks described below.

## Type annotations and static analysis

Our goal is to gradually add [type annotations][] to our code so that we can
catch errors earlier and be explicit about the interfaces expected and
provided.  Annotation pairs well with the functional approach taken by the
package.

During development you can run static type checks using [mypy][]:

    $ mypy nextstrain
    # No output is good!

and [pyright][]:

    $ npx pyright
    ...
    Found 40 source files
    0 errors, 0 warnings, 0 infos
    Completed in 2sec

There are also many [editor integrations for mypy][], and Pyright is integrated
into VS Code's Python support.

The [`typing_extensions`][] module should be used for features not yet available
in the the standard `typings` module of supported Python versions.

We also use [Flake8][] for some static analysis checks focusing on runtime
safety and correctness.  You can run them like this:

    $ flake8
    # No output is good!

## Documentation

A Sphinx project for Nextstrain CLI's documentation, primarily [reference and
explanatory material](https://documentation.divio.com), lives in the `doc/`
directory.  Pages are written in reStructuredText (rST), though some older
pages originally written in Markdown haven't been converted yet.

To locally build the HTML version of the documentation (i.e. what's served at
<https://docs.nextstrain.org/projects/cli/>), run:

    $ make -C doc livehtml

This will start a server on <http://localhost:8000> which you can browse.
Changes to source documentation files will be reflected automatically.


[Semantic Versioning rules]: https://semver.org
[nextstrain.org server]: https://github.com/nextstrain/nextstrain.org
["testing" configuration]: https://github.com/nextstrain/nextstrain.org/tree/@/env/testing/
[_signed_ tag]: https://git-scm.com/book/en/v2/Git-Tools-Signing-Your-Work
[CI workflow]: ../.github/workflows/ci.yaml
[source distributions]: https://packaging.python.org/en/latest/glossary/#term-Source-Distribution
[built distributions]: https://packaging.python.org/en/latest/glossary/#term-Built-Distribution
[type annotations]: https://www.python.org/dev/peps/pep-0484/
[mypy]: http://mypy-lang.org/
[pyright]: https://github.com/microsoft/pyright
[editor integrations for mypy]: https://github.com/python/mypy#integrations
[`typing_extensions`]: https://pypi.org/project/typing-extensions
[Flake8]: https://flake8.pycqa.org
